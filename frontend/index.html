<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QA Bot ‚Äî Frontend</title>
  <style>
    :root{
      --bg0:#070a12; --bg1:#0b1220; --card:#0f1a2e; --card2:#0b1527;
      --txt:#e8eefc; --muted:#a9b7d8; --muted2:#7f93c7;
      --br:#1a2a4a; --br2:#22365f;
      --ok:#14b8a6; --warn:#f59e0b; --bad:#ef4444; --info:#60a5fa;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --r: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--txt);
      background: radial-gradient(900px 900px at 15% 10%, #13224a 0%, rgba(19,34,74,0) 50%),
                  radial-gradient(700px 700px at 85% 20%, #0f3a3a 0%, rgba(15,58,58,0) 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:28px 18px 40px;}
    .top{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom:18px;
    }
    h1{margin:0; font-size:28px; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px; margin-top:6px}
    .pillrow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      padding:8px 10px; border:1px solid var(--br); background:rgba(255,255,255,.02);
      border-radius:999px; color:var(--muted); font-size:12px;
    }
    .grid{
      display:grid; grid-template-columns: 1.05fr .95fr; gap:16px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
    .card{
      border:1px solid var(--br);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
      border-radius: var(--r); box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px; border-bottom:1px solid var(--br);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(0,0,0,.12);
    }
    .card .bd{padding:16px;}
    .label{font-size:12px; color:var(--muted); margin-bottom:8px}
    input, textarea, select{
      width:100%; border:1px solid var(--br2);
      background: rgba(8,12,22,.6);
      color:var(--txt);
      padding:12px 12px; border-radius:12px;
      outline:none;
    }
    textarea{min-height:120px; resize:vertical; line-height:1.35}
    input:focus, textarea:focus, select:focus{border-color:#2e4b88; box-shadow:0 0 0 3px rgba(96,165,250,.15);}
    .row{display:grid; grid-template-columns: 1fr 220px 160px; gap:12px; align-items:end;}
    @media (max-width: 980px){ .row{grid-template-columns:1fr;} }
    .btns{display:flex; gap:10px; flex-wrap:wrap}
    button{
      border:1px solid var(--br2);
      background: linear-gradient(180deg, rgba(96,165,250,.20), rgba(96,165,250,.10));
      color:var(--txt);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
    }
    button.secondary{
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }
    button:disabled{opacity:.55; cursor:not-allowed}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--br2);
      background: rgba(255,255,255,.03);
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }
    .dot{width:8px; height:8px; border-radius:99px; background: var(--muted2)}
    .badge.ok{color:#baf7ef; border-color: rgba(20,184,166,.35); background: rgba(20,184,166,.10)}
    .badge.ok .dot{background: var(--ok)}
    .badge.fail{color:#ffd0d0; border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10)}
    .badge.fail .dot{background: var(--bad)}
    .badge.busy{color:#dbeafe; border-color: rgba(96,165,250,.35); background: rgba(96,165,250,.10)}
    .badge.busy .dot{background: var(--info)}
    .badge.idle{color:var(--muted)}
    .badge.idle .dot{background: var(--muted2)}
    .split{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .chat{
      display:flex; flex-direction:column; gap:10px;
      max-height: 440px; overflow:auto; padding-right:6px;
    }
    .msg{
      border:1px solid var(--br);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding:10px 12px;
    }
    .msg .t{font-size:12px; color:var(--muted); margin-bottom:6px}
    .msg.user{border-color: rgba(96,165,250,.28); background: rgba(96,165,250,.06)}
    .msg.bot{border-color: rgba(20,184,166,.25); background: rgba(20,184,166,.06)}
    pre{
      margin:0; white-space:pre-wrap; word-break:break-word;
      font-family: var(--mono);
      font-size:12px; color:#d9e6ff;
      background: rgba(0,0,0,.25);
      border:1px solid var(--br);
      padding:12px; border-radius:12px;
    }
    .kpi{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;
    }
    .kpi .box{
      border:1px solid var(--br);
      background: rgba(255,255,255,.02);
      border-radius: 14px; padding:10px 12px;
    }
    .kpi .big{font-size:18px; font-weight:800}
    .kpi .sm{font-size:12px; color:var(--muted)}
    table{
      width:100%; border-collapse:separate; border-spacing:0;
      overflow:hidden; border-radius: 14px; border:1px solid var(--br);
      background: rgba(255,255,255,.02);
      font-size:12px;
    }
    th, td{padding:10px 10px; border-bottom:1px solid var(--br); vertical-align:top}
    th{color:var(--muted); font-weight:700; background: rgba(0,0,0,.14); text-align:left}
    tr:last-child td{border-bottom:none}
    .mono{font-family:var(--mono)}
    a{color:#93c5fd; text-decoration:none}
    a:hover{text-decoration:underline}
    details{border:1px solid var(--br); background: rgba(255,255,255,.02); border-radius:14px; padding:10px 12px}
    summary{cursor:pointer; color:var(--muted); font-weight:700}
    .hint{color:var(--muted2); font-size:12px; margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>QA Bot</h1>
        <div class="sub">Convierte lenguaje natural en pasos Playwright y opcionalmente ejecuta la prueba.</div>
      </div>
      <div class="pillrow">
        <span class="pill">Backend: <span class="mono" id="apiBaseLabel">https://qa-bot-demoqa.onrender.com</span></span>
        <span class="pill">Endpoints: <span class="mono">/chat</span> ¬∑ <span class="mono">/chat_run</span></span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: INPUT -->
      <div class="card">
        <div class="hd">
          <div class="split">
            <span class="badge idle" id="statusBadge"><span class="dot"></span><span id="statusTxt">Listo</span></span>
            <span class="badge" title="Tip: usa headless=false para ver el navegador"><span class="dot"></span>Playwright</span>
          </div>
          <div class="btns">
            <button class="secondary" id="btnClear">Limpiar</button>
            <button class="secondary" id="btnExample">Ejemplo DemoQA</button>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <div class="label">API Base (tu FastAPI)</div>
              <input id="apiBase" value="https://qa-bot-demoqa.onrender.com" />
              <div class="hint">Si tu backend corre en otro puerto, c√°mbialo aqu√≠.</div>
            </div>
            <div>
              <div class="label">Modo</div>
              <select id="mode">
                <option value="chat_run">Generar + ejecutar (/chat_run)</option>
                <option value="chat">Solo generar steps (/chat)</option>
              </select>
            </div>
            <div>
              <div class="label">Headless</div>
              <select id="headless">
                <option value="false">false (ver navegador)</option>
                <option value="true">true (sin UI)</option>
              </select>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="label">Base URL (opcional)</div>
          <input id="baseUrl" placeholder="https://demoqa.com/text-box" value="https://demoqa.com/text-box" />

          <div style="height:12px"></div>

          <div class="label">Prompt</div>
          <textarea id="prompt">Llena el formulario DemoQA Text Box con nombre Fernanda QA, da submit y valida que aparezca el nombre en el resultado</textarea>

          <div style="height:12px"></div>

          <div class="btns">
            <button id="btnSend">Enviar</button>
            <button class="secondary" id="btnCopyCurl">Copiar cURL</button>
          </div>

          <div class="kpi" id="kpis" style="display:none;">
            <div class="box">
              <div class="sm">Status</div>
              <div class="big" id="kpiStatus">‚Äî</div>
            </div>
            <div class="box">
              <div class="sm">Duraci√≥n</div>
              <div class="big" id="kpiDur">‚Äî</div>
            </div>
          </div>

          <div style="height:12px"></div>

          <details id="rawBox" style="display:none;">
            <summary>Ver respuesta JSON cruda</summary>
            <div style="height:10px"></div>
            <pre id="rawJson"></pre>
          </details>

          <div class="hint" id="hintCORS">
            Si abriste este archivo con ‚Äúfile://‚Äù, usa un server local (te digo abajo) para evitar problemas de CORS.
          </div>
        </div>
      </div>

      <!-- RIGHT: OUTPUT -->
      <div class="card">
        <div class="hd">
          <div style="font-weight:800">Resultado</div>
          <div class="split">
            <span class="badge" title="Se guardan en tu carpeta evidence/ cuando falla"><span class="dot"></span>Evidencia</span>
          </div>
        </div>

        <div class="bd">
          <div class="chat" id="chat"></div>

          <div style="height:12px"></div>

          <div id="stepsBox" style="display:none;">
            <div class="label">Pasos</div>
            <table>
              <thead>
                <tr>
                  <th style="width:50px;">#</th>
                  <th style="width:160px;">Acci√≥n</th>
                  <th>Target</th>
                  <th style="width:110px;">Status</th>
                  <th style="width:120px;">Ms</th>
                </tr>
              </thead>
              <tbody id="stepsTbody"></tbody>
            </table>
          </div>

          <div style="height:12px"></div>

          <div id="evidenceBox" style="display:none;">
            <div class="label">Evidencia</div>
            <div class="msg bot">
              <div class="t">Bot</div>
              <div id="evidenceLinks"></div>
              <div class="hint">Nota: para abrir el PNG desde el navegador, conviene exponer /evidence en FastAPI (si quieres te paso el snippet).</div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const chat = $("chat");
    const statusBadge = $("statusBadge");
    const statusTxt = $("statusTxt");

    const apiBase = $("apiBase");
    const apiBaseLabel = $("apiBaseLabel");
    const mode = $("mode");
    const headless = $("headless");
    const baseUrl = $("baseUrl");
    const prompt = $("prompt");

    const btnSend = $("btnSend");
    const btnClear = $("btnClear");
    const btnExample = $("btnExample");
    const btnCopyCurl = $("btnCopyCurl");

    const kpis = $("kpis");
    const kpiStatus = $("kpiStatus");
    const kpiDur = $("kpiDur");

    const rawBox = $("rawBox");
    const rawJson = $("rawJson");

    const stepsBox = $("stepsBox");
    const stepsTbody = $("stepsTbody");

    const evidenceBox = $("evidenceBox");
    const evidenceLinks = $("evidenceLinks");

    function setStatus(state, text){
      statusTxt.textContent = text;
      statusBadge.className = "badge " + state;
    }

    function addMsg(text, who="bot"){
      const el = document.createElement("div");
      el.className = "msg " + who;
      el.innerHTML = `<div class="t">${who === "user" ? "T√∫" : "Bot"}</div><pre>${escapeHtml(text)}</pre>`;
      chat.appendChild(el);
      chat.scrollTop = chat.scrollHeight;
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }

    function pretty(obj){
      return JSON.stringify(obj, null, 2);
    }

    function parseBool(v){ return String(v).toLowerCase() === "true"; }

    function buildPayload(){
      const payload = {
        prompt: prompt.value.trim(),
        base_url: baseUrl.value.trim() || null
      };
      if (mode.value === "chat_run"){
        payload.headless = parseBool(headless.value);
      }
      return payload;
    }

    function buildCurl(){
      const endpoint = mode.value === "chat_run" ? "/chat_run" : "/chat";
      const url = apiBase.value.replace(/\/$/, "") + endpoint;
      const payload = buildPayload();
      return `curl -X POST '${url}' \\\n` +
             `  -H 'accept: application/json' \\\n` +
             `  -H 'Content-Type: application/json' \\\n` +
             `  -d '${JSON.stringify(payload)}'`;
    }

    function renderStepsTable(runResult, generatedSteps){
      // Preferimos el desglose real del runner si existe (run_result.steps)
      const rows = (runResult && Array.isArray(runResult.steps) && runResult.steps.length)
        ? runResult.steps.map(s => ({
            i: s.i,
            action: s.action,
            target: s.selector || s.url || "",
            status: s.status,
            ms: s.duration_ms ?? ""
          }))
        : (Array.isArray(generatedSteps) ? generatedSteps.map((s, idx) => ({
            i: idx + 1,
            action: s.action,
            target: s.selector || s.url || "",
            status: "‚Äî",
            ms: "‚Äî"
          })) : []);

      if (!rows.length){
        stepsBox.style.display = "none";
        stepsTbody.innerHTML = "";
        return;
      }

      stepsBox.style.display = "";
      stepsTbody.innerHTML = rows.map(r => {
        const badge = r.status === "pass" ? "ok" : (r.status === "fail" ? "fail" : "idle");
        return `
          <tr>
            <td class="mono">${r.i}</td>
            <td class="mono">${escapeHtml(r.action || "")}</td>
            <td class="mono">${escapeHtml(r.target || "")}</td>
            <td><span class="badge ${badge}"><span class="dot"></span>${escapeHtml(r.status || "‚Äî")}</span></td>
            <td class="mono">${escapeHtml(String(r.ms ?? ""))}</td>
          </tr>`;
      }).join("");
    }

    function renderEvidence(runResult){
      evidenceBox.style.display = "none";
      evidenceLinks.innerHTML = "";

      if (!runResult || !runResult.evidence) return;

      const fail = runResult.evidence.failure_screenshot;
      const fin  = runResult.evidence.final_screenshot;

      // Por ahora solo mostramos links si existen.
      // (Para que abran en navegador, hay que servir /evidence desde FastAPI)
      const links = [];
      if (fail) links.push({label:"Screenshot de falla", path: fail});
      if (fin)  links.push({label:"Screenshot final", path: fin});

      if (!links.length) return;

      evidenceBox.style.display = "";
      evidenceLinks.innerHTML = links.map(x => {
        return `<div style="margin:6px 0;">
          ‚Ä¢ <b>${escapeHtml(x.label)}:</b>
          <span class="mono">${escapeHtml(x.path)}</span>
        </div>`;
      }).join("");
    }

    function setKpis(runResult){
      if (!runResult){ kpis.style.display="none"; return; }
      kpis.style.display="";
      kpiStatus.textContent = runResult.status ? runResult.status.toUpperCase() : "‚Äî";
      kpiDur.textContent = (runResult.duration_ms != null) ? (runResult.duration_ms + " ms") : "‚Äî";
    }

    async function callApi(){
      const endpoint = mode.value === "chat_run" ? "/chat_run" : "/chat";
      const url = apiBase.value.replace(/\/$/, "") + endpoint;

      const payload = buildPayload();
      apiBaseLabel.textContent = apiBase.value;

      if (!payload.prompt){
        addMsg("Escribe un prompt primero üôÇ", "bot");
        return;
      }

      addMsg(payload.prompt, "user");
      setStatus("busy", "Ejecutando‚Ä¶");
      btnSend.disabled = true;
      rawBox.style.display = "none";
      evidenceBox.style.display = "none";
      stepsBox.style.display = "none";
      kpis.style.display = "none";

      try{
        const res = await fetch(url, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));

        // Mostrar crudo
        rawBox.style.display = "";
        rawJson.textContent = pretty(data);

        if (!res.ok){
          const msg = data.detail || data.message || res.statusText || "Error";
          addMsg("Error: " + msg, "bot");
          setStatus("fail", "Error");
          return;
        }

        // √âxito
        if (mode.value === "chat"){
          addMsg("‚úÖ Steps generados. Puedes ejecutarlos con /run o cambiar a modo /chat_run.", "bot");
          renderStepsTable(null, data.steps || []);
          setKpis(null);
          setStatus("ok", "OK");
          return;
        }

        // chat_run
        const rr = data.run_result || null;
        const gs = data.generated_steps || [];

        addMsg(`‚úÖ Ejecutado. Status: ${rr?.status || "‚Äî"} | Steps: ${rr?.meta?.steps_count ?? gs.length}`, "bot");

        if (rr?.status === "pass") setStatus("ok", "PASS");
        else if (rr?.status === "fail") setStatus("fail", "FAIL");
        else setStatus("ok", "OK");

        setKpis(rr);
        renderStepsTable(rr, gs);
        renderEvidence(rr);

      } catch(e){
        addMsg("Fallo de conexi√≥n: " + e.message, "bot");
        setStatus("fail", "Sin conexi√≥n");
      } finally {
        btnSend.disabled = false;
      }
    }

    btnSend.addEventListener("click", callApi);

    btnClear.addEventListener("click", () => {
      chat.innerHTML = "";
      rawBox.style.display = "none";
      stepsBox.style.display = "none";
      evidenceBox.style.display = "none";
      kpis.style.display = "none";
      setStatus("idle", "Listo");
    });

    btnExample.addEventListener("click", () => {
      baseUrl.value = "https://demoqa.com/text-box";
      prompt.value = "Llena el formulario DemoQA Text Box con nombre Fernanda QA, da submit y valida que aparezca el nombre en el resultado";
      mode.value = "chat_run";
      headless.value = "false";
    });

    btnCopyCurl.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(buildCurl());
        addMsg("üìã cURL copiado al portapapeles.", "bot");
      }catch{
        addMsg("No pude copiar. Aqu√≠ est√° el cURL:\n\n" + buildCurl(), "bot");
      }
    });

    // estado inicial
    setStatus("idle", "Listo");
  </script>
</body>
</html>